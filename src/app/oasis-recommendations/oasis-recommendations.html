<aside
  class="flex flex-col bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm h-[calc(100vh+100px)]"
>
  <!-- ANALYZER ALERTS -->
  <section
    *ngIf="showAnalyzer() && analyzerAlerts() && analyzerAlerts().length > 0"
    class="mb-4 bg-white border border-amber-200 rounded-xl shadow-sm overflow-hidden"
  >
    <header
      (click)="toggleAlertsCollapsed()"
      class="px-3 py-2 border-b border-amber-100 flex items-center justify-between cursor-pointer hover:bg-amber-50 transition-colors"
    >
      <div class="flex items-center gap-2">
        <ion-icon
          [name]="isAlertsCollapsed() ? 'chevron-forward' : 'chevron-down'"
          class="text-amber-600 text-sm"
        ></ion-icon>
        <div>
          <h2 class="text-[0.65rem] font-semibold tracking-wide text-amber-800 uppercase">
            Analyzer Alerts
          </h2>
          <p class="text-[0.65rem] text-slate-500">Flags documentation vs OASIS consistency.</p>
        </div>
      </div>
      <span
        class="inline-flex items-center px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 text-[0.65rem] font-medium"
      >
        {{ newAnalyzerAlertCount }} new
      </span>
    </header>

    <div *ngIf="!isAlertsCollapsed()" class="max-h-64 overflow-y-auto divide-y divide-slate-100">
      <article
        *ngFor="let alert of analyzerAlerts()"
        (click)="handleAlertClick(alert, $event)"
        class="alert-card px-3 py-2.5 cursor-pointer hover:bg-slate-50 transition-colors"
        [ngClass]="{
          'bg-amber-50': alert.status === 'new',
          dismissed: alert.status === 'dismissed'
        }"
      >
        <div class="flex items-start justify-between">
          <div class="flex-1 pr-2">
            <div class="flex items-center space-x-2 mb-1">
              <span
                class="text-[0.6rem] font-semibold uppercase tracking-wide"
                [ngClass]="{
                  'text-emerald-700': alert.type === 'coding_opportunity',
                  'text-sky-700': alert.type === 'inconsistency'
                }"
              >
                {{ alert.type === 'coding_opportunity' ? 'Coding Opp.' : 'Inconsistency' }}
              </span>

              <span
                class="text-[0.6rem] px-1.5 py-0.5 rounded-full"
                [ngClass]="{
                  'bg-red-100 text-red-700': alert.severity === 'high',
                  'bg-amber-100 text-amber-700': alert.severity === 'medium',
                  'bg-slate-100 text-slate-600': alert.severity === 'low'
                }"
              >
                {{ alert.severity | titlecase }}
              </span>

              <span
                class="text-[0.6rem] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-500"
                *ngIf="alert.status !== 'new'"
              >
                {{ alert.status | titlecase }}
              </span>
            </div>

            <h3 class="text-[0.7rem] font-semibold text-slate-900 mb-0.5">
              {{ alert.title }}
            </h3>

            <p class="text-[0.65rem] text-slate-600 leading-snug mb-0.5 line-clamp-3">
              {{ alert.description }}
            </p>

            <p class="text-[0.6rem] text-slate-500">
              Evidence:
              <span class="font-medium">{{ alert.evidenceDocId }}</span>
              <span *ngIf="alert.hippsImpact">
                â€¢ Impact:
                <span class="font-medium text-emerald-700">
                  {{ alert.hippsImpact.delta | currency : 'USD' : 'symbol' : '1.0-0' }}
                </span>
              </span>
            </p>
          </div>

          <div class="flex flex-col items-end space-y-1 text-[0.6rem]">
            <!-- Active Alert: Show Evidence, Reviewed, Dismiss buttons -->
            @if (alert.status !== 'dismissed') {
            <button
              type="button"
              (click)="handleAlertClick(alert, $event)"
              class="px-2 py-1 rounded border border-slate-300 text-slate-700 hover:bg-slate-50 flex items-center space-x-1"
            >
              <ion-icon name="search-outline" class="text-[0.6rem]"></ion-icon>
              <span>Evidence</span>
            </button>

            <button
              type="button"
              (click)="handleAlertStatusChange(alert, 'reviewed', $event)"
              class="px-2 py-0.5 rounded text-slate-500 hover:text-slate-700 hover:bg-slate-100"
            >
              Reviewed
            </button>

            <button
              type="button"
              (click)="handleAlertStatusChange(alert, 'dismissed', $event)"
              class="px-2 py-0.5 rounded text-slate-400 hover:text-rose-600 hover:bg-rose-50"
            >
              Dismiss
            </button>
            }

            <!-- Dismissed Alert: Show status label and Undo button -->
            @if (alert.status === 'dismissed') {
            <span class="px-2 py-1 rounded bg-slate-200 text-slate-600 font-medium">
              âœ— Dismissed
            </span>
            <button
              type="button"
              (click)="handleAlertStatusChange(alert, 'new', $event)"
              class="px-2 py-0.5 rounded text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 font-medium"
            >
              Undo
            </button>
            }
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- Header - Collapsible -->
  <div
    (click)="toggleRecsCollapsed()"
    class="px-6 py-4 border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors flex items-center justify-between"
  >
    <div class="flex items-center gap-2">
      <ion-icon
        [name]="isRecsCollapsed() ? 'chevron-forward' : 'chevron-down'"
        class="text-slate-600 text-sm"
      ></ion-icon>
      <div>
        <h2 class="text-sm font-semibold text-slate-900">AI Recommendations</h2>
        <p class="text-xs text-slate-500 mt-0.5">
          Review stroke-related diagnoses and functional status suggestions
        </p>
      </div>
    </div>
    <span class="text-xs text-slate-400">{{ recommendations().length }} items</span>
  </div>

  <!-- Collapsible Content -->
  @if (!isRecsCollapsed()) {
  <!-- Payment Optimization Alert Banner -->
  <div class="bg-blue-50 border-b border-blue-100 px-6 py-4">
    <div class="flex items-start space-x-3">
      <div class="bg-blue-500 rounded-full p-1 flex-shrink-0 mt-0.5">
        <ion-icon name="information" class="text-white text-sm"></ion-icon>
      </div>
      <div class="flex-1">
        <h3 class="text-xs font-semibold text-blue-900 mb-1">High-Value Stroke Comorbidity</h3>
        <p class="text-xs text-blue-700 leading-relaxed mb-2">
          Aspiration pneumonia (J69.0) and dysphagia linked to recent stroke may qualify this
          episode for a higher comorbidity tier when accurately captured.
        </p>
        <div class="flex items-center justify-between text-xs">
          <span class="text-blue-600">Tier: None â†’ High</span>
          <span class="text-blue-900 font-semibold">+$287</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Recommendations List -->
  <div id="recommendations-list" class="flex-1 overflow-y-auto px-6 py-4 space-y-3">
    <div
      *ngFor="let rec of recommendations()"
      class="recommendation-card border border-slate-200 bg-white rounded-xl p-4 cursor-pointer hover:border-slate-300 hover:shadow-sm transition-all"
      [class.accepted]="rec.status === 'accepted'"
      [class.rejected]="rec.status === 'rejected'"
      (click)="handleRecommendationSelect(rec, $event)"
      [attr.data-form-id]="rec.formFieldId"
    >
      <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
          <p class="text-[0.65rem] uppercase tracking-wide text-slate-500">
            {{ rec.headerLabel }}
          </p>
          <h3 class="text-xs font-semibold text-slate-900">
            {{ rec.title }}
          </h3>
        </div>

        <span
          *ngIf="rec.badgeLabel"
          class="inline-flex items-center px-2 py-0.5 rounded-full text-[0.65rem] font-medium"
          [ngClass]="rec.badgeClass"
        >
          {{ rec.badgeLabel }}
        </span>
      </div>

      <p class="text-xs text-slate-600 mb-3 leading-relaxed" [innerHTML]="rec.rationaleHtml"></p>

      <div class="flex items-center justify-between text-xs mb-3 pb-3 border-b border-slate-100">
        <span class="text-slate-500">{{ rec.contextLabel }}</span>
        <span class="text-slate-500">ðŸ“„ {{ rec.evidenceDocLabel }}</span>
      </div>

      <div class="flex space-x-2">
        <!-- Pending State: Accept Button -->
        <button
          *ngIf="rec.status === 'pending'"
          (click)="handleRecommendationAccept(rec, $event)"
          class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium py-2 rounded-lg transition-colors"
        >
          Accept
        </button>

        <!-- Accepted State: Show status + Undo button -->
        <button
          *ngIf="rec.status === 'accepted'"
          disabled
          class="flex-1 bg-emerald-500 text-white text-xs font-medium py-2 rounded-lg cursor-default"
        >
          âœ“ Accepted
        </button>

        <!-- Rejected State: Show status + Undo button -->
        <button
          *ngIf="rec.status === 'rejected'"
          disabled
          class="flex-1 bg-slate-400 text-white text-xs font-medium py-2 rounded-lg cursor-default"
        >
          âœ— Rejected
        </button>

        <!-- Undo Button (for accepted/rejected) -->
        <button
          *ngIf="rec.status === 'accepted' || rec.status === 'rejected'"
          (click)="handleRecommendationUndo(rec, $event); $event.stopPropagation()"
          class="px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-medium py-2 rounded-lg transition-colors"
        >
          Undo
        </button>

        <!-- Reject Button (only for pending) -->
        <button
          *ngIf="rec.status === 'pending'"
          (click)="handleRecommendationReject(rec, $event)"
          class="px-3 text-slate-400 hover:text-slate-600 text-xs font-medium transition-colors"
        >
          Reject
        </button>
      </div>
    </div>
  </div>
  }
</aside>
